service: pollen-paw-backend
useDotenv: true

# AWS provider configuration
provider:
  name: aws
  runtime: nodejs20.x  
  region: us-east-2    
  stage: ${opt:stage, 'dev'}
  profile: pollen-paw
  
  environment:
    GOOGLE_MAPS_API_KEY: ${env:GOOGLE_MAPS_API_KEY}
    DB_HOST: ${env:DB_HOST}
    DB_PORT: ${env:DB_PORT}
    DB_NAME: ${env:DB_NAME}
    DB_USER: ${env:DB_USER}
    DB_PASSWORD: ${env:DB_PASSWORD}
    S3_BUCKET: ${env:S3_BUCKET}
    JWT_SECRET: ${env:JWT_SECRET}
    JWT_EXPIRES_IN: ${env:JWT_EXPIRES_IN}
    NODE_ENV: ${env:NODE_ENV}

  # IAM permissions for Lambda functions
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: '*'
        - Effect: Allow
          Action:
            - s3:GetObject
            - s3:PutObject
            - s3:DeleteObject
          Resource: 
            - "arn:aws:s3:::${env:S3_BUCKET}/*"
            - "arn:aws:s3:::${env:S3_BUCKET}"

# Lambda function definitions
functions:
  # ============================================
  # Auth API (New Section)
  # ============================================
  registerUser:
    handler: src/handlers/auth/register.handler
    description: Simple user registration for demo
    timeout: 10
    memorySize: 256
    events:
      - http:
          path: auth/register
          method: post
          cors: true
          
  # ============================================
  # Environmental Data API
  # ============================================
  getPollenData:
    handler: src/handlers/environmental/getPollenData.handler
    description: Retrieves pollen forecast data from Google Pollen API 
    timeout: 30
    memorySize: 256
    events:
      - http:
          path: environmental/pollen
          method: get
          cors: true

  # ============================================
  # Pet Management API
  # ============================================
  getPets:
    handler: src/handlers/pets/getPets.handler
    description: Fetch all pets for authenticated user
    timeout: 15
    memorySize: 256
    events:
      - http:
          path: pets
          method: get
          cors: true

  getPet:
    handler: src/handlers/pets/getPet.handler
    description: Fetch single pet by ID
    timeout: 15
    memorySize: 256
    events:
      - http:
          path: pets/{id}
          method: get
          cors: true

  createPet:
    handler: src/handlers/pets/createPet.handler
    description: Create new pet profile
    timeout: 15
    memorySize: 256
    events:
      - http:
          path: pets
          method: post
          cors: true

  updatePet:
    handler: src/handlers/pets/updatePet.handler
    description: Update existing pet profile
    timeout: 15
    memorySize: 256
    events:
      - http:
          path: pets/{id}
          method: put
          cors: true

  deletePet:
    handler: src/handlers/pets/deletePet.handler
    description: Delete pet profile
    timeout: 15
    memorySize: 256
    events:
      - http:
          path: pets/{id}
          method: delete
          cors: true

  # ============================================
  # Symptom Logging API
  # ============================================
  getSymptoms:
    handler: src/handlers/symptoms/getSymptoms.handler
    description: Fetch symptom logs for a pet (includes joined pollen data)
    timeout: 20
    memorySize: 256
    events:
      - http:
          path: symptoms
          method: get
          cors: true

  createSymptom:
    handler: src/handlers/symptoms/createSymptom.handler
    description: Create new symptom log and auto-fetch pollen data
    timeout: 30 # Increased timeout for external API call
    memorySize: 512 # 
    events:
      - http:
          path: symptoms
          method: post
          cors: true

  updateSymptom:
    handler: src/handlers/symptoms/updateSymptom.handler
    description: Update existing symptom log
    timeout: 15
    memorySize: 256
    events:
      - http:
          path: symptoms/{id}
          method: put
          cors: true

  deleteSymptom:
    handler: src/handlers/symptoms/deleteSymptom.handler
    description: Delete symptom log
    timeout: 15
    memorySize: 256
    events:
      - http:
          path: symptoms/{id}
          method: delete
          cors: true

  # ============================================
  # File Upload API
  # ============================================
  uploadPhoto:
    handler: src/handlers/upload/uploadPhoto.handler
    description: Generate presigned URL for S3 photo upload
    timeout: 10
    memorySize: 256
    events:
      - http:
          path: upload
          method: post
          cors: true

# External plugins
plugins:
  - serverless-esbuild        
  - serverless-dotenv-plugin  
  - serverless-offline        

# Plugin configuration
custom:
  esbuild:
    bundle: true              
    minify: false # Set to false for easier debugging
    sourcemap: true           
    exclude: ['aws-sdk', 'pg-native']
    target: 'node20'          
    platform: 'node'
  
  serverless-offline:
    httpPort: 3000            
    lambdaPort: 3002

# Packaging settings
package:
  individually: true