service: pollen-paw-backend
useDotenv: true

# AWS provider configuration
provider:
  name: aws
  runtime: nodejs20.x  
  region: us-east-2    
  stage: ${opt:stage, 'dev'}
  profile: pollen-paw
  
  # Mapping environment variables from .env to the Lambda execution environment
  environment:
    GOOGLE_MAPS_API_KEY: ${env:GOOGLE_MAPS_API_KEY}
    DB_HOST: ${env:DB_HOST}
    DB_PORT: ${env:DB_PORT}
    DB_NAME: ${env:DB_NAME}
    DB_USER: ${env:DB_USER}
    DB_PASSWORD: ${env:DB_PASSWORD}
    S3_BUCKET: ${env:S3_BUCKET}
    JWT_SECRET: ${env:JWT_SECRET}
    JWT_EXPIRES_IN: ${env:JWT_EXPIRES_IN}
    NODE_ENV: ${env:NODE_ENV}

  # AWS Identity and Access Management (IAM) permissions for the Lambda functions
  # Defines what AWS services this Lambda function can access
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: '*'
        - Effect: Allow
          Action:
            - s3:GetObject
            - s3:PutObject
          Resource: 
            - "arn:aws:s3:::${env:S3_BUCKET}/*"
            - "arn:aws:s3:::${env:S3_BUCKET}"

# lambda function definitions and configurations
functions:
  getPollenData:
    handler: src/handlers/environmental/getPollenData.handler
    description: Retrieves pollen forecast data from the Google Pollen API 
    timeout: 30
    memorySize: 256
    events:
      - http:
          path: environmental/pollen
          method: get
          cors: true

# external Serverless Framework plugins
plugins:
  - serverless-esbuild        # compiles TS to JS and bundles dependencies
  - serverless-dotenv-plugin  # loads .env files and makes variables available
  - serverless-offline        # allow AWS Lambda and API Gateway work locally

# Configuration for plugins
custom:
  esbuild:
    bundle: true              # Bundles all dependencies into a single file
    minify: true              # Reduces code size for faster cold starts
    sourcemap: true           # Enables easier debugging in CloudWatch
    exclude: ['aws-sdk']      # Prevents bundling AWS SDK as it is pre-installed on Lambda
    target: 'node20'          # Matches the provider runtime
    platform: 'node'
  
  serverless-offline:
    httpPort: 3000            # Local API endpoint port
    lambdaPort: 3002

# Packaging settings
package:
  individually: true          # Bundles each function separately to minimize package size